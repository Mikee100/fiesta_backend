// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Customer {
  id        String   @id @default(cuid())
  name      String
  email     String?  @unique
  phone     String?
  whatsappId String? @unique // WhatsApp sender ID
  instagramId String? @unique // Instagram sender ID
  messengerId String? @unique // Messenger sender ID
  aiEnabled Boolean  @default(true) // AI enabled for this customer
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages  Message[]
  bookings  Booking[]
  bookingDrafts BookingDraft[]

  @@map("customers")
}

model Message {
  id        String   @id @default(cuid())
  content   String
  platform  String   // whatsapp, instagram, messenger, telegram
  direction String   // inbound, outbound
  customerId String
  customer  Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  externalId String? @unique // External message ID to prevent duplicates
  createdAt DateTime @default(now())
  handledBy String? // 'agent' or 'ai'
  isResolved Boolean?
  isEscalated Boolean?

  @@map("messages")
}

model Booking {
  id          String   @id @default(cuid())
  customerId  String
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  service     String
  dateTime    DateTime
  status      String   // provisional, confirmed, cancelled
  durationMinutes Int? // duration in minutes for the service
  recipientName String?
  recipientPhone String?
  googleEventId String? @unique // Google Calendar event ID
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("bookings")
}

model KnowledgeBase {
  id        String   @id @default(cuid())
  question  String
  answer    String
  category  String
  embedding Float[]  // vector for Pinecone
  createdAt DateTime @default(now())

  @@map("knowledge_base")
}

model BookingDraft {
  id          String   @id @default(cuid())
  customerId  String
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  service     String?
  date        String?  // e.g., "2025-11-20"
  time        String?  // e.g., "9:00 AM"
  dateTimeIso String?  // ISO-8601 UTC string for scheduling
  name        String?
  recipientName String?
  recipientPhone String?
  isForSomeoneElse Boolean?
  step        String   // current step: service, date, time, name, confirm
  version     Int      @default(1) // For optimistic locking
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  payment     Payment?

  @@unique([customerId]) // One draft per customer
  @@map("booking_drafts")
}

model Package {
  id          String   @id @default(cuid())
  name        String   @unique
  type        String   // 'outdoor' or 'studio'
  price       Int      // in KSH
  deposit     Int      @default(2000) // deposit amount in KSH (default for migration)
  duration    String   // e.g., '2 hrs', '1 hr 30 mins'
  images      Int      // number of soft copy images
  makeup      Boolean  // professional makeup included
  outfits     Int      // number of own outfits
  styling     Boolean  // styling included
  photobook   Boolean  // photobook included
  photobookSize String? // e.g., '8x8"'
  mount       Boolean  // A3 mount included
  balloonBackdrop Boolean // Customised balloon backdrop included
  wig         Boolean  // Styled wig included
  notes       String?  // extra notes
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("packages")
}

model StudioInfo {
  id        String   @id @default(cuid())
  location  String
  notes     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("studio_info")
}

model Payment {
  id             String      @id @default(cuid())
  bookingDraftId String?     @unique
  bookingDraft   BookingDraft? @relation(fields: [bookingDraftId], references: [id], onDelete: Cascade)
  amount         Int         // deposit amount
  phone          String      // customer's phone for M-Pesa
  status         String      // pending, success, failed
  mpesaReceipt   String?     // M-Pesa receipt number
  checkoutRequestId String?  // M-Pesa CheckoutRequestID
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@map("payments")
}

model AiSettings {
  id        Int    @id @default(1)
  aiEnabled Boolean @default(true)
  updatedAt DateTime @updatedAt

  @@map("ai_settings")
}

model AiPrediction {
  id           Int      @id @default(autoincrement())
  timestamp    DateTime @default(now())
  input        String
  prediction   String
  actual       String?
  confidence   Float?
  responseTime Int      // ms
  error        String?
  userFeedback Int?     // 1-5 rating
  modelVersion String?
}
